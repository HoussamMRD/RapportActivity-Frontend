

<div class="content-wrapper  p-0">
    <div class="content-body">

        <!--  les filtres-->
        <div class="card  border-success">
            <div class="card-body">
                <!--  filter start -->

                <div class="users-list-filter">
                    <form>
                        <div class="row">

                            <!-- Type de filtre-->
                            <div class="col-1 col-md-1" *ngIf="filterLogistiques">
                                <fieldset class="form-group">
                                    <label>Filtrer par :</label>
                                    <ng-select
                                            [searchable]="true"
                                            [clearable]="false"
                                            [items]="filterLogistiques"
                                            [(ngModel)]="filterLogistique"
                                            name="filterLogistique"
                                            bindLabel="name"
                                            placeholder="Le filtre"
                                            (change)="onFilterTypeChange()">
                                    </ng-select>
                                </fieldset>
                            </div>


                            <!-- Par Année-->
                            <div class="col-1 col-md-1" *ngIf="years && filterLogistique.value === LogistiqueFilter.MONTH">
                                <fieldset class="form-group">
                                    <label>L'Année</label>
                                    <ng-select
                                            [searchable]="true"
                                            [clearable]="false"
                                            [items]="years"
                                            [(ngModel)]="selectedYear"
                                            name="selectedYear"
                                            bindLabel="name"
                                            placeholder="Sélectionner l'année"
                                            (change)="loadRoutes()">
                                    </ng-select>
                                </fieldset>
                            </div>

                            <!--  Par Année-->
                            <div class="col-1 col-md-1" *ngIf="months && filterLogistique.value === LogistiqueFilter.MONTH">
                                <fieldset class="form-group">
                                    <label>Le mois</label>
                                    <ng-select
                                            [searchable]="true"
                                            [clearable]="false"
                                            [items]="months"
                                            [(ngModel)]="selectedMonth"
                                            name="selectedMonth"
                                            bindLabel="name"
                                            placeholder="Sélectionner le mois"
                                            (change)="loadRoutes()">
                                    </ng-select>
                                </fieldset>
                            </div>


                            <!-- Search by Date (Daily) -->
                            <div class="col-2 col-md-2" *ngIf="filterLogistique.value === LogistiqueFilter.DAY">
                                <div class="form-group">
                                    <label for="filterDate" class="filter-label">Date:</label>
                                    <div class="input-wrapper">
                                        <input class="form-control"
                                               type="date"
                                               id="filterDate"
                                               [(ngModel)]="filterDate"
                                               name="filterDate"
                                               (change)="loadRoutes()"
                                               placeholder=" "/>
                                    </div>
                                </div>
                            </div>


                            <!-- Search by Vehicle Name -->
                            <div class="col-4 col-md-2">
                                <div class="form-group">
                                    <label for="filterVehiculeName" class="filter-label">Nom du Véhicule :</label>

                                    <div class="input-group mb-2">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text" id="basic-addon-search1"><i data-feather="search"></i></span>
                                        </div>
                                        <input id="filterVehiculeName" type="text"
                                               class="form-control"
                                               aria-label="Search..."
                                               [(ngModel)]="filterVehiculeName"
                                               name="filterVehiculeName"
                                               placeholder="Rechercher par nom du véhicule"
                                               (keyup)="filterData()"
                                               aria-describedby="basic-addon-search1"/>

                                    </div>
                                </div>

                            </div>

                            <div class="col-4 col-md-2">
                                <div class="form-group">
                                    <div class="custom-control custom-control-primary custom-switch">
                                        <p class="mb-50">Les lignes avec 0 Km</p>
                                        <input type="checkbox"
                                               checked
                                               class="custom-control-input"
                                               id="customSwitch3"
                                               [(ngModel)]="showZeroKmRows"
                                               name="showZeroKmRows"
                                               (change)="toggleZeroKmRows($event)"
                                               [ngModelOptions]="{standalone: true}"/>
                                        <label class="custom-control-label" for="customSwitch3"></label>
                                    </div>
                                </div>
                            </div>


                        </div>
                    </form>
                </div>

                <!--  filter end -->

            </div>
        </div>
        <!-- / les filtres-->

        <!--  loading Screen -->
        <core-loading-screen id="loading-bg" *ngIf="loading">
            <div class="loading-logo">
                <!--        <img src="assets/images/logo/appIconeFullColors.png" alt="Logo"/>-->
                <!--        <img src="assets/images/logo/icon-color-complet.ico" alt="Logo"/>-->
                <img src="assets/images/logo/dot-loading.svg" alt="Logo"/>

            </div>
            <div class="loading">
                <div class="effect-1 effects"></div>
                <div class="effect-2 effects"></div>
                <div class="effect-3 effects"></div>
            </div>
        </core-loading-screen>
        <!-- /  loading Screen -->

        <!--  Data -->
        <div class="card  border-success" *ngIf="!loading">
            <div class="card-body">
                <!-- Table displaying filtered data -->
                <ngx-datatable [rows]="filteredRoutes" [rowHeight]="50" class="bootstrap core-bootstrap" [limit]="20"
                               [columnMode]="ColumnMode.force" [headerHeight]="50" [footerHeight]="50" [scrollbarH]="true">

                    <ngx-datatable-column name="Date" prop="date" [width]="150">
                        <ng-template let-row="row" ngx-datatable-cell-template>
                            {{ row.date | date: 'dd/MM/yyyy' }}

                        </ng-template>
                    </ngx-datatable-column>

                    <ngx-datatable-column name="Vehicule" prop="vehiculeGpsLocation.name" [width]="150">
                        <ng-template let-row="row" ngx-datatable-cell-template>
                            <div>
                                <strong>{{ row.vehiculeGpsLocation?.name }}</strong>
                                <br>
                                <span *ngIf="row.vehiculeGpsLocation?.costPerKm>0"
                                      class="badge badge-pill badge-success">
                        Cout/km :{{ row.vehiculeGpsLocation?.costPerKm|number }} Dh
                    </span>
                            </div>
                        </ng-template>
                    </ngx-datatable-column>

                    <ngx-datatable-column name="Type" prop="vehiculeGpsLocation.group_name" [width]="150">
                        <ng-template let-row="row" ngx-datatable-cell-template>
                            <div>
                                <strong>{{ row.vehiculeGpsLocation?.group_name }}</strong>
                                <br>
                                <span class="badge badge-pill badge-warning">
                        {{ row.chauffeurName }}
                    </span>
                            </div>
                        </ng-template>
                    </ngx-datatable-column>

                    <ngx-datatable-column name="Km parcouru" prop="routeLength" [width]="150">
                        <ng-template let-row="row" ngx-datatable-cell-template>
                            <div *ngIf="selectedRow?.id === row.id; else viewMode" class="d-flex align-items-center">
                                <input [(ngModel)]="row.routeLength" class="form-control mr-2" type="number"/>
                                <!-- Save Icon -->
                                <i class="fa fa-check text-success mr-3" style="cursor: pointer;font-size: 1.5rem;" (click)="updateRouteLength(row)"></i>
                                <!-- Cancel Icon -->
                                <i class="fa fa-times text-secondary" style="cursor: pointer;font-size: 1.5rem;" (click)="cancelEdit()"></i>
                            </div>
                            <ng-template #viewMode>
                                <strong (click)="editRow(row)" style="color: forestgreen; cursor: pointer;">
                                    {{ row.routeLength }} km
                                </strong>
                            </ng-template>
                        </ng-template>
                    </ngx-datatable-column>


                    <ngx-datatable-column name="Cout du Voyage" prop="costPerTrip" [width]="150">
                        <ng-template let-row="row" ngx-datatable-cell-template>
                            {{ row.costPerTrip | currency: ' ' }}
                        </ng-template>
                    </ngx-datatable-column>

                    <ngx-datatable-column name="% Remplissage" [width]="200">
                        <ng-template let-row="row" ngx-datatable-cell-template>
                            <div class="d-flex align-items-center">
                                <select [(ngModel)]="row.fillingPercentage" class="form-control" [style.width.px]="100">
                                    <option *ngFor="let option of [0,25, 50, 75, 100]" [value]="option">
                                        {{ option }}%
                                    </option>
                                </select>
                                <button style="color: orange;" type="button" class="btn btn-primary ml-2"
                                        (click)="confirmFillingPercentage(row)">
                                    Confirm
                                </button>
                            </div>
                        </ng-template>
                    </ngx-datatable-column>

                    <ngx-datatable-column name="Coût du perte" prop="fillingCost" [width]="150">
                        <ng-template let-row="row" ngx-datatable-cell-template>
                            <strong style="color: orangered;">{{ row.costPerTrip - row.fillingCost | currency: ' ' }}</strong>
                        </ng-template>
                    </ngx-datatable-column>
                    <ngx-datatable-column name="Status" [width]="150">
                        <ng-template let-row="row" ngx-datatable-cell-template>
                            <!--<span class="badge" [ngClass]="{
                              'badge-success': row.status === 'Complet',
                              'badge-warning': row.status === 'Imputation en attente',
                              'badge-danger': row.status === 'Manquant' }">
                                {{ row.status }}
                            </span>-->

                            <div class="form-group">
                                <div class="custom-control custom-checkbox custom-control-inline">
                                    <input [disabled]="true" type="checkbox" class="custom-control-input" id="from"
                                           [ngModelOptions]="{standalone: true}"
                                           [(ngModel)]="row.fromStatus"/>
                                    <label class="custom-control-label" for="from">From</label>
                                </div>
                                <div class="custom-control custom-checkbox custom-control-inline">
                                    <input [disabled]="true" type="checkbox" class="custom-control-input" id="imputation"
                                           [ngModelOptions]="{standalone: true}"
                                           [(ngModel)]="row.imputationStatus"/>
                                    <label class="custom-control-label" for="imputation">Imputation</label>
                                </div>

                            </div>

                        </ng-template>
                    </ngx-datatable-column>


                    <ngx-datatable-column name="Actions" [width]="40" [sortable]="false">
                        <ng-template ngx-datatable-cell-template let-row="row">
                            <div ngbDropdown container="body">
                                <button ngbDropdownToggle type="button" class="btn icon-btn btn-sm hide-arrow" rippleEffect>
                                    <span [data-feather]="'more-vertical'" class="cursor-pointer"></span>
                                </button>
                                <div ngbDropdownMenu>
                                    <a (click)="openModalFromTo(associationModal, row)" ngbDropdownItem>
                                        <span data-feather="link" class="mr-50"></span> From -> To
                                    </a>
                                    <a (click)="openModalsViewImputations(imputationModal, row)" ngbDropdownItem>
                                        <span data-feather="edit" class="mr-50"></span> Imputation
                                    </a>
                                </div>
                            </div>
                        </ng-template>
                    </ngx-datatable-column>

                </ngx-datatable>

            </div>
        </div>
        <!--  /Data -->


    </div>
</div>


<!--Details From modal-->
<ng-template #associationModal let-modal>
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Details From</h5>
                <button type="button" class="btn btn-close btn-lg" aria-label="Close" (click)="modal.dismiss()">
                    <span aria-hidden="true" style="font-size: 1.5rem;">&times;</span>
                </button>
            </div>

            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead>
                        <tr>
                            <th>Affaire</th>
                            <th>Fournisseur</th>
                            <th>BL</th>
                            <th>BL Montant</th>
                            <th>Date BL</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr *ngFor="let fromMouvement of fromMouvements">
                            <td>{{ fromMouvement.affaireCode || '-' }}</td>
                            <td>{{ fromMouvement.fournisseurName || '-' }}</td>
                            <td>{{ fromMouvement.bl }}</td>
                            <td>{{ fromMouvement.blMontant }}</td>
                            <td>{{ fromMouvement.dateBl | date:'yyyy-MM-dd' }}</td>
                            <td>
                                <div ngbDropdown class="dropdown">
                                    <button ngbDropdownToggle class="btn btn-light" type="button">&#x22EE;</button>
                                    <div ngbDropdownMenu>
                                        <a class="dropdown-item"
                                           (click)="openEditFromMouvementModal(fromMouvement)">Edit</a>
                                        <a class="dropdown-item text-danger"
                                           (click)="removeFromMouvement(fromMouvement)">Delete</a>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer" style="background-color: #f8f9fa; border-top: 1px solid #dee2e6; padding: 1rem;">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <button type="button" class="btn btn-success" (click)="openAddFromMouvementModal()">
                        + Ajouter FromMouvement
                    </button>
                </div>
            </div>
        </div>
    </div>
</ng-template>

<!--addFromMouvementModal-->
<ng-template #addFromMouvementModal let-modal>
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter From Mouvement</h5>
                <button type="button" class="btn btn-close btn-lg" aria-label="Close" (click)="modal.dismiss()">
                    <span aria-hidden="true" style="font-size: 1.5rem;">&times;</span>
                </button>
            </div>

            <div class="modal-body">
                <form (ngSubmit)="saveFromMouvement(modal)">
                    <div class="row">

                        <!-- Affaire Field -->
                        <div class="col-md-6">

                            <label for="affaire">Affaire</label>
                            <fieldset class="form-group">
                                <ng-select [clearable]="true" [items]="affaires"
                                           [(ngModel)]="currentFromMouvement.affaire" name="affaires" bindLabel="code">
                                </ng-select>
                            </fieldset>

                        </div>


                        <!--&lt;!&ndash; Affaire Field &ndash;&gt;
                        <div class="col-md-6">
                            <label for="newAffaire">Affaire</label>
                            <select id="newAffaire" class="form-control custom-input-select"
                                    [(ngModel)]="currentFromMouvement.affaireId" name="newAffaire" required
                                    (change)="onAffaireChange()" [disabled]="isAffaireDisabled">
                                <option *ngFor="let affaire of affaires" [ngValue]="affaire.id">
                                    {{ affaire.code }}
                                </option>
                            </select>
                        </div>-->

                        <!-- Fournisseur Field -->
                        <div class="col-md-6" *ngIf="fournisseurs && fournisseurs.length > 0">

                            <label for="affaire">Fournisseur</label>
                            <fieldset class="form-group">
                                <ng-select [clearable]="true" [items]="fournisseurs"
                                           [(ngModel)]="currentFromMouvement.fournisseur" name="frs"
                                           bindLabel="intituleFournisseur">
                                </ng-select>
                            </fieldset>

                        </div>


                        <!--&lt;!&ndash; Fournisseur Field &ndash;&gt;
                        <div class="col-md-6" *ngIf="fournisseurs && fournisseurs.length > 0">
                            <label for="newFournisseur">Fournisseur</label>
                            <select id="newFournisseur" class="form-control custom-input-select"
                                    [(ngModel)]="currentFromMouvement.fournisseurId" name="newFournisseur" required
                                    (change)="onFournisseurChange()" [disabled]="isFournisseurDisabled">
                                <option *ngFor="let fournisseur of fournisseurs" [ngValue]="fournisseur.id">
                                    {{ fournisseur.intituleFournisseur }}
                                </option>
                            </select>
                        </div>-->


                        <!-- BL Field -->
                        <div class="col-md-6">
                            <label for="newBl">BL</label>
                            <input type="text" id="newBl" class="form-control" [(ngModel)]="currentFromMouvement.bl"
                                   name="newBl" required/>
                        </div>

                        <!-- BL Montant Field -->
                        <div class="col-md-6">
                            <label for="newBlMontant">BL Montant</label>
                            <input type="number" id="newBlMontant" class="form-control"
                                   [(ngModel)]="currentFromMouvement.blMontant" name="newBlMontant" required/>
                        </div>

                        <!-- Date BL Field -->
                        <div class="col-md-6">
                            <label for="newDateBl">Date BL</label>
                            <input type="date" id="newDateBl" class="form-control"
                                   [(ngModel)]="currentFromMouvement.dateBl" name="newDateBl" required/>
                        </div>
                    </div>

                    <div class="modal-footer"
                         style="background-color: #f8f9fa; border-top: 1px solid #dee2e6; padding: 1rem;">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary mr-1">Sauvegarder From Mouvement</button>
                                <button type="button" class="btn btn-outline-secondary"
                                        (click)="modal.dismiss()">Annuler
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</ng-template>

<!--editeFromMouvementModal-->
<ng-template #editeFromMouvementModal let-modal>
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modifier From Mouvement</h5>
                <button type="button" class="btn btn-close btn-lg" aria-label="Close" (click)="modal.dismiss()">
                    <span aria-hidden="true" style="font-size: 1.5rem;">&times;</span>
                </button>
            </div>

            <div class="modal-body">
                <form (ngSubmit)="updateFromMouvement(modal)">
                    <div class="row">
                        <!-- Affaire Field -->
                        <div class="col-md-6">

                            <label for="affaire">Affaire</label>
                            <fieldset class="form-group">
                                <ng-select [clearable]="true" [items]="affaires"
                                           [(ngModel)]="fromMouvementResponseDTO.affaire" name="affaires" bindLabel="code">
                                </ng-select>
                            </fieldset>

                        </div>

                        <!-- Fournisseur Field -->
                        <div class="col-md-6" *ngIf="fournisseurs && fournisseurs.length > 0">

                            <label for="affaire">Fournisseur</label>
                            <fieldset class="form-group">
                                <ng-select [clearable]="true" [items]="fournisseurs"
                                           [(ngModel)]="fromMouvementResponseDTO.fournisseur" name="frs"
                                           bindLabel="intituleFournisseur">
                                </ng-select>
                            </fieldset>

                        </div>

                        <!-- BL Field -->
                        <div class="col-md-6">
                            <label for="newBlNewFromTo">BL</label>
                            <input type="text" id="newBlNewFromTo" class="form-control"
                                   [(ngModel)]="fromMouvementResponseDTO.bl" name="newBl" required/>
                        </div>

                        <!-- BL Montant Field -->
                        <div class="col-md-6">
                            <label for="newBlMontantFromTo">BL Montant</label>
                            <input type="number" id="newBlMontantFromTo" class="form-control"
                                   [(ngModel)]="fromMouvementResponseDTO.blMontant" name="newBlMontant" required/>
                        </div>

                        <!-- Date BL Field -->
                        <div class="col-md-6">
                            <h4 class="card-title">Date BL</h4>
                            <fieldset class="form-group">

                                <date-picker-i18n [ngbDateStruct]=ngbDateBl
                                                  (dateSelectedEvent)="onDateBlChange($event)">
                                </date-picker-i18n>

                            </fieldset>

                        </div>
                    </div>

                    <div class="modal-footer"
                         style="background-color: #f8f9fa; border-top: 1px solid #dee2e6; padding: 1rem;">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary mr-1">Sauvegarder From Mouvement</button>
                                <button type="button" class="btn btn-outline-secondary"
                                        (click)="modal.dismiss()">Annuler
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</ng-template>


<!-- Existing Modal for Imputation Details -->
<ng-template #imputationModal let-modal>
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Details Imputation</h5>
                <button type="button" class="btn btn-close btn-lg" aria-label="Close" (click)="modal.dismiss()">
                    <span aria-hidden="true" style="font-size: 1.5rem;">&times;</span>
                </button>
            </div>

            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead>
                        <tr>
                            <th>Affaire</th>
                            <th>% Imputation</th>
                            <th>Observation</th>
                            <th>Client</th>
                            <th>Lot</th>
                            <th>Sous-traitant</th>
                            <th>Cost</th>
                            <th>Action</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr *ngFor="let imputation of imputations">
                            <td>{{ imputation.affaireCode }}</td>
                            <td>{{ imputation.fillingPercentage | number:'1.2-2' }}%</td>
                            <td>{{ imputation.observation }}</td>
                            <td>{{ imputation.clientName }}</td>
                            <td>{{ imputation.lotName }}</td>
                            <td>{{ imputation.subContractorFullName }}</td>
                            <td>{{ imputation.costImputation | number:'1.2-2' }} MAD</td>
                            <td>
                                <div ngbDropdown class="dropdown">
                                    <button ngbDropdownToggle class="btn btn-light" type="button">&#x22EE;</button>
                                    <div ngbDropdownMenu>
                                        <a class="dropdown-item"
                                           (click)="openEditImputationModal(imputation)">Modifier</a>
                                        <a class="dropdown-item text-danger"
                                           (click)="removeImputation(imputation)">Supprimer</a>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer" style="background-color: #f8f9fa; border-top: 1px solid #dee2e6; padding: 1rem;">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <button type="button" class="btn btn-success" (click)="openAddImputationModal()">
                        + Add Imputation
                    </button>
                    <div class="total-cost"
                         style="background-color: #e2f0d9; border-radius: 5px; padding: 10px; font-weight: bold;">
                        <span style="color: #28a745;">Total Cost:</span>
                        <span style="color: #333;">{{ getTotalCostImputation() | number:'1.2-2' }} MAD</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</ng-template>

<!-- add-imputation-modal -->
<ng-template #addImputationModal let-modal>
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Imputation</h5>
                <button type="button" class="btn btn-close" aria-label="Close" (click)="modal.dismiss()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body">
                <form #form="ngForm" (ngSubmit)="saveImputation(modal)">
                    <div class="row">
                        <div class="col-md-6 col-12">
                            <div class="form-group">
                                <!-- <label for="affaireId">Affaire</label>
                                 <select id="affaireId" class="form-control"
                                         [(ngModel)]="newImputation.affaireId"
                                         name="affaireId"
                                         required
                                         (change)="onAffaireChanged(newImputation.affaireId)">
                                     <option *ngFor="let affaire of affaires" [ngValue]="affaire.id">
                                         {{ affaire.code }}
                                     </option>
                                 </select>-->

                                <label for="affaire">Affaire</label>
                                <fieldset class="form-group">
                                    <ng-select id="affaire" [clearable]="false" [items]="affaires"
                                               [(ngModel)]="tripImputationResponseDTO.affaire" name="affaires" bindLabel="code"
                                               (change)="onAffaireChanged($event)">
                                    </ng-select>
                                </fieldset>


                                <div *ngIf="form.controls['affaireId']?.invalid && form.controls['affaireId']?.touched"
                                     class="text-danger">
                                    Affaire is required.
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 col-12">
                            <div class="form-group">
                                <label for="fillingPercentage">Filling Percentage</label>
                                <input type="number" id="fillingPercentage" class="form-control"
                                       [(ngModel)]="tripImputationResponseDTO.fillingPercentage" name="fillingPercentage"
                                       (keyup)="onFillingKeyUp()" required min="0" max="100" step="0.01"/>
                                <div *ngIf="form.controls['fillingPercentage']?.invalid && form.controls['fillingPercentage']?.touched"
                                     class="text-danger">
                                    Filling Percentage is required and must be between 0 and 100.
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 col-12">
                            <div class="form-group">
                                <label for="observation">Observation</label>
                                <input type="text" id="observation" class="form-control"
                                       [(ngModel)]="tripImputationResponseDTO.observation" name="observation"/>
                            </div>
                        </div>

                        <div class="col-md-6 col-12">
                            <div class="form-group">


                                <!-- <label for="clientId">Client</label>
                                 <select id="clientId" class="form-control"
                                         [(ngModel)]="newImputation.client"
                                         name="clientId"
                                         required>
                                     <option *ngFor="let client of clients" [ngValue]="client.id">
                                         {{ client.name }}
                                     </option>
                                 </select>-->


                                <label for="client">Client</label>
                                <fieldset class="form-group">
                                    <ng-select id="client" [clearable]="true" [items]="clients"
                                               [(ngModel)]="tripImputationResponseDTO.client" name="clients" bindLabel="name"
                                               (change)="onClientChanged($event)">
                                    </ng-select>
                                </fieldset>

                                <div *ngIf="form.controls['clientId']?.invalid && form.controls['clientId']?.touched"
                                     class="text-danger">
                                    Client is required.
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 col-12">
                            <div class="form-group">
                                <!-- <label for="lotId">Lot</label>
                                 <select id="lotId" class="form-control"
                                         [(ngModel)]="newImputation.lotId"
                                         name="lotId">
                                     <option *ngFor="let lot of lots" [ngValue]="lot.id">
                                         {{ lot.name }}
                                     </option>
                                 </select>-->

                                <label for="lot">Lot</label>
                                <fieldset class="form-group">
                                    <ng-select id="lot" [clearable]="true" [items]="lots"
                                               [(ngModel)]="tripImputationResponseDTO.lot" name="lots" bindLabel="name"
                                               (change)="onLotChanged($event)">
                                    </ng-select>
                                </fieldset>


                            </div>
                        </div>

                        <div class="col-md-6 col-12">
                            <div class="form-group">
                                <!-- <label for="subContractorId">Sous-traitant</label>
                                 <select id="subContractorId" class="form-control"
                                         (change)="onSubcontractorChanged(newImputation.subContractorId)"
                                         [(ngModel)]="newImputation.subContractorId"
                                         name="subContractorId">
                                     <option *ngFor="let soustraitant of soustraitants" [ngValue]="soustraitant.id">
                                         {{ soustraitant?.fullName }}
                                     </option>
                                 </select>-->


                                <label for="subContractor">Sous-traitant</label>
                                <fieldset class="form-group">
                                    <ng-select id="subContractor" [clearable]="true" [items]="subContractors"
                                               [(ngModel)]="tripImputationResponseDTO.soustraitant" name="soustraitants"
                                               bindLabel="fullName" (change)="onSubcontractorChanged($event)">
                                    </ng-select>
                                </fieldset>


                            </div>
                        </div>

                        <div class="col-md-6 col-12">
                            <div class="form-group">
                                <label>Cost</label>
                                <div class="form-control-plaintext">
                                    {{ tripImputationResponseDTO.costImputation | number:'1.2-2' }}
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <button type="submit" class="btn btn-primary mr-1">Sauvegarder Imputation</button>
                            <button type="button" class="btn btn-outline-secondary" (click)="modal.dismiss()">Annuler
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</ng-template>

<!-- edite-imputation-modal -->
<ng-template #editeImputationModal let-modal>
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modifier Imputation</h5>
                <button type="button" class="btn btn-close" aria-label="Close" (click)="modal.dismiss()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body">
                <form #form="ngForm" (ngSubmit)="updateImputation(modal)">
                    <div class="row">
                        <div class="col-md-6 col-12">
                            <div class="form-group">
                                <!-- <label for="affaireEditedId">Affaire</label>
                                 <select id="affaireEditedId" class="form-control"
                                         [(ngModel)]="newImputation.affaireId"
                                         name="affaireId"
                                         required
                                         (change)="onAffaireChanged(newImputation.affaireId)">
                                     <option *ngFor="let affaire of affaires" [ngValue]="affaire.id">
                                         {{ affaire.code }}
                                     </option>
                                 </select>-->

                                <label for="affaireEditedId">Affaire</label>
                                <fieldset class="form-group">
                                    <ng-select id="affaireEditedId" [clearable]="false" [items]="affaires"
                                               [(ngModel)]="tripImputationResponseDTO.affaire" name="affaires" bindLabel="code"
                                               (change)="onAffaireChanged($event)">
                                    </ng-select>
                                </fieldset>

                                <div *ngIf="form.controls['affaireId']?.invalid && form.controls['affaireId']?.touched"
                                     class="text-danger">
                                    Affaire is required.
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 col-12">
                            <div class="form-group">
                                <label for="fillingPercentageEdited">Pourcentage de Remplessage </label>
                                <input type="number" id="fillingPercentageEdited" class="form-control"
                                       [(ngModel)]="tripImputationResponseDTO.fillingPercentage" name="fillingPercentage"
                                       (keyup)="onFillingKeyUp()" required min="0" max="100" step="0.01"/>
                                <div *ngIf="form.controls['fillingPercentage']?.invalid && form.controls['fillingPercentage']?.touched"
                                     class="text-danger">
                                    Filling Percentage is required and must be between 0 and 100.
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 col-12">
                            <div class="form-group">
                                <label for="observationEdited">Observation</label>
                                <input type="text" id="observationEdited" class="form-control"
                                       [(ngModel)]="tripImputationResponseDTO.observation" name="observation"/>
                            </div>
                        </div>

                        <div class="col-md-6 col-12">
                            <div class="form-group">
                                <!-- <label for="clientEditedId">Client</label>
                                 <select id="clientEditedId" class="form-control"
                                         [(ngModel)]="newImputation.clientId"
                                         name="clientId"
                                         required>
                                     <option *ngFor="let client of clients" [ngValue]="client.id">
                                         {{ client.name }}
                                     </option>
                                 </select>-->


                                <label for="clientEditedId">Client</label>
                                <fieldset class="form-group">
                                    <ng-select id="clientEditedId" [clearable]="true" [items]="clients"
                                               [(ngModel)]="tripImputationResponseDTO.client" name="clients" bindLabel="name">
                                    </ng-select>
                                </fieldset>

                                <div *ngIf="form.controls['clientId']?.invalid && form.controls['clientId']?.touched"
                                     class="text-danger">
                                    Client is required.
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 col-12">
                            <div class="form-group">
                                <!-- <label for="lotEditedId">Lot</label>
                                 <select id="lotEditedId" class="form-control"
                                         [(ngModel)]="newImputation.lotId"
                                         name="lotId">
                                     <option *ngFor="let lot of lots" [ngValue]="lot.id">
                                         {{ lot.name }}
                                     </option>
                                 </select>-->


                                <label for="lotEditedId">Lot</label>
                                <fieldset class="form-group">
                                    <ng-select id="lotEditedId" [clearable]="true" [items]="lots"
                                               [(ngModel)]="tripImputationResponseDTO.lot" name="lots" bindLabel="name">
                                    </ng-select>
                                </fieldset>
                            </div>
                        </div>

                        <div class="col-md-6 col-12">
                            <div class="form-group">
                                <!--<label for="subContractorEditedId">Sous-traitant</label>
                                <select id="subContractorEditedId" class="form-control"
                                        (change)="onSubcontractorChanged(newImputation.subContractorId)"
                                        [(ngModel)]="newImputation.subContractorId"
                                        name="subContractorId">
                                    <option *ngFor="let soustraitant of soustraitants" [ngValue]="soustraitant.id">
                                        {{ soustraitant?.fullName }}
                                    </option>
                                </select>-->


                                <label for="subContractorEditedId">Sous-traitant</label>
                                <fieldset class="form-group">
                                    <ng-select id="subContractorEditedId" [clearable]="true" [items]="subContractors"
                                               [(ngModel)]="tripImputationResponseDTO.soustraitant" name="soustraitants"
                                               bindLabel="fullName" (change)="onSubcontractorChanged($event)">
                                    </ng-select>
                                </fieldset>
                            </div>
                        </div>

                        <div class="col-md-6 col-12">
                            <div class="form-group">
                                <label>Cost</label>
                                <div class="form-control-plaintext">
                                    {{ tripImputationResponseDTO.costImputation | number:'1.2-2' }} MAD
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <button type="submit" class="btn btn-primary mr-1">Modifier Imputation</button>
                            <button type="button" class="btn btn-outline-secondary" (click)="modal.dismiss()">Annuler
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</ng-template>

